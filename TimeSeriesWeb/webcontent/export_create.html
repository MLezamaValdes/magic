<!DOCTYPE html>
<html lang="en">
<head>
<title>Export Time Series</title>
<link rel="stylesheet" type="text/css" href="querytimeseries.css">
<meta charset="utf-8">
<script src="jquery-2.1.1.min.js"></script>
<script src="util.js"></script>

<script>

var id = -1;
var total_plots = -1;

function ready() {

getID("status").innerHTML = "start creating zip-file";

$.get("/export/create")
	.done(function(data) {
		id = data.id;
		total_plots = data.plots;
		getID("progress").max = total_plots;
		getID("status").innerHTML = "with id "+id;
		window.setTimeout(function() {get_output();}, 100);
	}).fail(function() {
		getID("status").innerHTML = "error";
	});	


}

function get_output() {
$.get("/export/create_get_output?id="+id)
	.done(function(data) {
		var processed_plots = data.processed_plots;
		getID("progress").value = processed_plots;
		getID("progressLabel").innerHTML = "processed "+processed_plots + " of " + total_plots + " plots";
		var output_lines = data.output_lines;
		if(output_lines.length>0) {
			var out = "";
			for(i in output_lines) {
				out += output_lines[i]+"\n";
			}
			append_output(out);
		}		
		if(!data.finished) {
			window.setTimeout(function() {get_output();}, 500);
		} else {
			getID("status").innerHTML = "ready";
			handle_download(data.filename);			
		}
	}).fail(function() {
		append_output("\nerror");
		getID("status").innerHTML = "ready";		
	});
}

function append_output(text) {
	$("#output").val($("#output").val()+text);
	getID("output").scrollTop = getID("output").scrollTopMax;
}

function handle_download(filename) {
	getID("download").innerHTML = "plots processed ";
	var a = document.createElement('a');
	a.appendChild(document.createTextNode("click to download"));
	a.title = "link to resulting zip file";
	a.href = "/download/"+filename;
	getID("download").appendChild(a);
}

$(document).ready(ready);
</script>


</head>
<body>
<div class="bg">
<p style="text-align:right"><a href="index.html">back to Start Page<a><br><a href="export.html">back to Export Summary Page</a><p>
<h1 style="text-align:center">Export Time Series</h1>
<div style="text-align:right">
<button id="button_instructions" onclick="show_instructions()">Show Instructions</button>
</div>
<div style="display:inline-block">status:</div>
<div id="status" style="display:inline-block">init...</div> 
<hr/>
</div>
<div id="div_instructions" style="display:none">
<script type="text/javascript">
function show_instructions() {
	if(document.getElementById("div_instructions").style.display==="none") {
		document.getElementById("div_instructions").style.display = "inline";
		document.getElementById("button_instructions").innerHTML = "Hide Instructions";
	} else {
		document.getElementById("div_instructions").style.display = "none";
		document.getElementById("button_instructions").innerHTML = "Show Instructions";
	}
}
</script>
<h3>Instructions</h3>
On this page you can view the progress of processing the chosen plots. Wait until it's done. Then you get a link to download the resulting zip file.
<hr/>
</div>
<p>
<progress id="progress" style="width:700px"></progress>&nbsp;&nbsp;&nbsp;<span id="progressLabel"></span>
</p>
<p>
<div id="download">
processing plots (download not ready)
</div>
</p>
<p>
<textarea id="output" cols="100" rows="30" wrap="soft" readonly="readonly">init...</textarea>
</p>

</body>
</html>