<!DOCTYPE html>
<html lang="en">
<head>
<title>Export Time Series - choose sensors</title>
<meta charset="utf-8">
<script src="/static/jquery-2.1.1.min.js"></script>
<script src="jquery-ui.min.js"></script>
<script src="/static/util.js"></script>
<script type="text/javascript">

var chosen_select;
var available_select;

var chosen_sensors = [];
var available_sensors = ["plot0","plot1","plot2","plot3"];

var tasks = 0;

var incTask = function() {
	tasks++;	
	getID("status").innerHTML = "busy ("+tasks+")...";
}

var decTask = function() {
	tasks--;
	if(tasks===0) {
		getID("status").innerHTML = "ready";
	} else if(tasks<0){
		getID("status").innerHTML = "error";
	} else {
		getID("status").innerHTML = "busy ("+tasks+")...";
	}
}

var update_chosen_select = function() {
	chosen_select.innerHTML = "";
	for(i in chosen_sensors) {
		chosen_select.add(new Option(chosen_sensors[i],i));
	}
}

var update_available_select = function() {
	available_select.innerHTML = "";
	for(r in available_sensors) {
		var sensor = available_sensors[r];
		var available = true;	
		for(i in chosen_sensors) {
			if(sensor==chosen_sensors[i]) {
				available = false;
				break;
			}			
		}
		if(available) {
			available_select.add(new Option(sensor,r));
		}
	}
}

var arrayToText = function(a) {
	var s = "";
	for(i in a) {
		if(i>0) {
			s+="\n";
		}
		s+=a[i];
	}
	return s;
}

var busy_count = 0;

var setStateBusy = function() {
	busy_count++;
	console.log("(inc) "+busy_count);
	document.getElementById("busy").style.visibility = "visible";
}

var setStateReady = function() {
	busy_count--;
	console.log("(dec) "+busy_count);
	if(busy_count<1) {
		document.getElementById("busy").style.visibility = "hidden";
	}
}

$(document).ready(function(){
	setStateBusy();
	


	chosen_select = document.getElementById("chosen_select");
	available_select = document.getElementById("available_select");

	chosen_select.ondblclick = function(){
		setStateBusy();
		chosen_sensors.splice(chosen_select.value,1);
		update_chosen_select();
		update_available_select();
		setStateReady();
	};
	
	available_select.ondblclick = function(){
		setStateBusy();
		chosen_sensors.push(available_sensors[available_select.value]);
		update_chosen_select();
		update_available_select();
		setStateReady();
	}
	
	$("#button_cancel").button();
	document.getElementById("button_cancel").onclick = function() {
		setStateBusy();
		window.location = "/static/export.html";
		setStateReady();
	}
	
	$("#button_apply").button();
	document.getElementById("button_apply").onclick = function() {	
		setStateBusy();
		$.post("/export/apply_sensors",arrayToText(chosen_sensors))
		 .done(function() {
			window.location = "/static/export.html";
			setStateReady();
		 })
		 .fail(function() {alert("error sending data");setStateReady();})		 
	}
	
	setStateBusy();
	$.get("/export/sensors").done(function(data) {		
		chosen_sensors = [];
		rows = splitData(data);
		for(i in rows) {
			chosen_sensors.push(rows[i][0]);
		}
		update_chosen_select();
		update_available_select();
		setStateReady();
	}).fail(function() {alert("error getting data");setStateReady();});
	
	var get_sensor_list = function(region) {
		setStateBusy();
		$.get("/tsdb/region_sensor_list?region="+region).done(function(data) {
			available_sensors = [];
			rows = splitData(data);
			for(i in rows) {
				available_sensors.push(rows[i][0]);
			}
			update_chosen_select();
			update_available_select();
			setStateReady();
		}).fail(function() {alert("error getting data");setStateReady();});
	}

	var get_region = function() {
		incTask();
		$.get("/export/region").done(function(data) {
			var rows = splitData(data);	
			var region = rows[0][0];
			get_sensor_list(region);
			decTask();
		}).fail(function() {alert("error getting data");decTask();});	
	}

	get_region();
	update_chosen_select();
	update_available_select();
	
	setStateReady();
})

</script>

<link rel="stylesheet" href="jquery-ui.css">
<link rel="stylesheet" type="text/css" href="querytimeseries.css">

</head>

<body>
<p style="text-align:right"><a href="/static/export.html">back to Export Time Series<a><p>
<h1 style="text-align:center">Export Time Series - choose sensors</h1>
<p id="busy" style="text-align:right;visibility:hidden">busy...<p>
<div style="display:inline-block">status:</div>
<div id="status" style="display:inline-block">init...</div> 
<hr/>
<h3>Actions</h3>
<button id="button_cancel">cancel</button>
<button id="button_apply">apply chosen sensors</button>
<hr/>
<h3>Select Sensors</h3>

<p>
<div style="display:inline-block;width:200px;vertical-align:top">
<label for="chosen_select">Chosen Sensors</label>
<select id="chosen_select" size="5" multiple="multiple" style="height:300px">
<option>plt1</option>
<option>plt2</option>
</select>
</div>
<div style="display:inline-block;width:100px;vertical-align:top">
</div>
<div style="display:inline-block;width:200px;vertical-align:top">
<label for="available_select">Available Sensors</label>
<select id="available_select" size="5" multiple="multiple" style="height:300px">
<option>plt1</option>
<option>plt2</option>
</select>
</div>
</p>
</body>
</html>