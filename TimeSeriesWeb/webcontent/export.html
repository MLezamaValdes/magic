<!DOCTYPE html>
<html lang="en">
<head>
<title>Export Time Series</title>
<meta name="robots" content="noindex" />
<meta charset="utf-8">
<link rel="icon" type="image/png" href="favicon.png" />
<script src="jquery-2.1.1.min.js"></script>
<script src="jquery-ui.min.js"></script>
<script src="util.js"></script>
<script type="text/javascript">

var tasks = 0;

var incTask = function() {
	tasks++;	
	getID("status").innerHTML = "busy ("+tasks+")...";
}

var decTask = function() {
	tasks--;
	if(tasks===0) {
		getID("status").innerHTML = "ready";
	} else if(tasks<0){
		getID("status").innerHTML = "error";
	} else {
		getID("status").innerHTML = "busy ("+tasks+")...";
	}
}

$(document).ready(function(){
incTask();
var plots_output = getID("plots_output");
var sensors_output = getID("sensors_output");
var settings_output = getID("settings_output");
var region_output = getID("region_output");
var timespan_output = getID("timespan_output");
var aggregation_output = getID("aggregation_output");

clear_println(region_output,"query data...");
incTask();
$.get("../export/region").done(function(data) {
		var rows = splitData(data);
		clear(region_output);		
		region_output.innerHTML = rows[0][1];
		decTask();
	}).fail(function() {clear_println(region_output,"error getting data");decTask();});
	
clear_println(timespan_output,"query data...");
/*incTask();
$.get("../export/timespan").done(function(data) {
		var value = +data;
		var timespanText = "[not valid timespan]";
		if(value===0) {
			timespanText = "[all]";
		} else {
			timespanText = "year "+value;
		}
		
		timespan_output.innerHTML = timespanText;
		decTask();
	}).fail(function() {clear_println(timespan_output,"error getting data");decTask();});*/	

clear_println(plots_output,"query data...");
incTask();
$.get("../export/plots").done(function(data) {
		clear(plots_output);
		var rows = splitData(data);
		for(i in rows) {
			println(plots_output, rows[i]);
		}
		decTask();		
	}).fail(function() {clear_println(plots_output,"error getting data");decTask();});

clear_println(sensors_output,"query data...");
incTask();	
$.get("../export/sensors").done(function(data) {
		clear(sensors_output);
		var rows = splitData(data);
		for(i in rows) {
			println(sensors_output, rows[i]);
		}
		decTask();
	}).fail(function() {clear_println(sensors_output,"error getting data");decTask();});
	
clear_println(settings_output,"query data...");
incTask();
$.getJSON("../export/settings").done(function( data ) {
		var json_settings = data;
		console.log(JSON.stringify(json_settings));		
		clear(settings_output);
		var settings_array = [];
		//{"col_plotid":true,"col_timestamp":false,"col_datetime":false}
		
		var timespan_type = json_settings.timespan_type;
		
		var timespanText;
		if(timespan_type=="all") {
			timespanText = "[all available data]";
		} else if(timespan_type=="year"){
			timespanText = "year "+json_settings.timespan_year;
		} else if(timespan_type=="years"){
			timespanText = "years "+json_settings.timespan_years_from+" to "+json_settings.timespan_years_to;
		} else if(timespan_type=="dates"){
			timespanText = "dates from "+json_settings.timespan_dates_from+" to "+json_settings.timespan_dates_to;			
			
		} else {
			timespanText = "[not valid timespan]";
		}		
		
		/*var value = +json_settings.timespan;
		var timespanText = "[not valid timespan]";
		if(value===0) {
			timespanText = "[all]";
		} else {
			timespanText = "year "+value;
		}*/		
		timespan_output.innerHTML = timespanText;
		aggregation_output.innerHTML = json_settings.timestep;
		var raw = false;
		if(json_settings.timestep=="raw") {
			aggregation_output.innerHTML = "collect raw measured values:  no quality checks or interpolation can be performed";
			raw = true;
		}		
		if(!raw) {
			settings_array.push("quality check: "+json_settings.quality);		
			if(json_settings.interpolate) {
				settings_array.push("interpolate missing values");
			}
		}		
		if(json_settings.desc_sensor) {
			settings_array.push("include sensor description");
		}
		if(json_settings.desc_plot) {
			settings_array.push("include plot description");
		}		
		if(json_settings.desc_settings) {
			settings_array.push("include settings description");
		}
		if(json_settings.allinone) {
			settings_array.push("all plots in one file");
		} else {
			settings_array.push("one file per plot");
		}
		if(!json_settings.write_header) {
			settings_array.push("not write CSV header");
		}		
		array_to_html_list(settings_output,settings_array);
		decTask();
	})
	.fail(function(data) {clear_println(settings_output,"error getting data");decTask();});	

$("#button_instructions").button();
	
$("#choose_region").button();
document.getElementById("choose_region").onclick = function() {
	window.location = "export_region.html";
}	
	
$("#choose_sensors").button();
document.getElementById("choose_sensors").onclick = function() {
	window.location = "export_sensors.html";
}		
	
$("#choose_plots").button();
document.getElementById("choose_plots").onclick = function() {
	window.location = "export_plots.html";
}

$("#choose_time").button();
document.getElementById("choose_time").onclick = function() {
	window.location = "export_time.html";
}

$("#download").button();
document.getElementById("download").onclick = function() {
	incTask();
	window.location = "../export/result.zip";
	decTask();
}

$("#create").button();
document.getElementById("create").onclick = function() {
	window.location = "export_create.html";
}

$("#button_settings").button();
document.getElementById("button_settings").onclick = function() {window.location = "export_settings.html";};	
decTask();

//incTask();	
$.get("../tsdb/region_list").done(function(data) {
		var rows = splitData(data);
		if(rows.length<2) {
			$("#choose_region").hide();
		}
		//decTask();
	}).fail(function() {/*clear_println(sensors_output,"error getting data");decTask();*/});

});

var show_instructions = function() {
	if(document.getElementById("div_instructions").style.display==="none") {
		document.getElementById("div_instructions").style.display = "inline";
		document.getElementById("button_instructions").innerHTML = "Hide Instructions";
	} else {
		document.getElementById("div_instructions").style.display = "none";
		document.getElementById("button_instructions").innerHTML = "Show Instructions";
	}
}

</script>

<link rel="stylesheet" href="jquery-ui.css">
<link rel="stylesheet" type="text/css" href="querytimeseries.css">

</head>

<body>
<div class="bg">
<p style="text-align:right"><a href="index.html">back to Start Page<a><br>Export Summary Page<p>
<p style="text-align:right"><p>
<h1 style="text-align:center">Export Time Series</h1>
<div style="text-align:right">
<button id="button_instructions" onclick="show_instructions()">Show Instructions</button>
</div>
<div style="display:inline-block">status:</div>
<div id="status" style="display:inline-block">init...</div> 
<hr/>
</div>
<div id="div_instructions" style="display:none">
<h3>Instructions</h3>
<p>On this page time series data can be downloaded as a zip-file.</p>
<p>The summary section of this page shows currently chosen plots, parameters and other settings for this zip-file.</p>
<p>In the actions section of this page settings can be changed.</p>
At the right side of the actions section you can download the generated zip, with the specified settings. Before downloading check at the summary section if you chose suitable settings.
<hr/>
</div>
<h3>Actions</h3>
<button id="choose_region">choose region</button>
<button id="choose_sensors">choose parameters</button>
<button id="choose_plots">choose plots</button>
<button id="choose_time">choose time</button>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<button id="button_settings">settings</button>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
<button id="download"><b>download ZIP-File</b></button>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <button id="create">(create ZIP-File [experimantal]) </button>


<hr/>

<h3>Summary of exported time series</h3>
<h4 style="display:inline-block">Region&nbsp; &nbsp; &nbsp;</h4>
<div id="region_output" style="display:inline-block"></div>
<br/>
<h4 style="display:inline-block">Time&nbsp; &nbsp; &nbsp;</h4>
timespan of &nbsp;&nbsp;
<b><div id="timespan_output" style="display:inline-block"></div></b>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
with time steps of &nbsp;&nbsp;
<b><div id="aggregation_output" style="display:inline-block"></div></b>
<br/>
<br/>
<div style="display:inline-block;width:300px;line-height:0;vertical-align:top">
<h4>Settings</h4>
<div id="settings_output" style="height:200px"></div>
</div>
<div style="display:inline-block;width:200px;line-height:0;vertical-align:top">
<h4>Parameters</h4>
<div id="sensors_output"></div>
</div>
<div style="display:inline-block;width:400px;line-height:0;vertical-align:top">
<h4>Plots</h4>
<div id="plots_output"></div>
</div>




</body>
</html>