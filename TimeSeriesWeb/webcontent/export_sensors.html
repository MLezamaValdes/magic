<!DOCTYPE html>
<html lang="en">
<head>
<title>Export Time Series - choose sensors</title>
<meta charset="utf-8">
<script src="jquery-2.1.1.min.js"></script>
<script src="jquery-ui.min.js"></script>
<script src="util.js"></script>
<script type="text/javascript">

var chosen_select;
var available_select;

var chosen_sensors = [];
var available_sensors = ["plot0","plot1","plot2","plot3"];

var tasks = 0;

var incTask = function() {
	tasks++;	
	getID("status").innerHTML = "busy ("+tasks+")...";
}

var decTask = function() {
	tasks--;
	if(tasks===0) {
		getID("status").innerHTML = "ready";
	} else if(tasks<0){
		getID("status").innerHTML = "error";
	} else {
		getID("status").innerHTML = "busy ("+tasks+")...";
	}
}

var update_chosen_select = function() {
	chosen_select.innerHTML = "";
	for(i in chosen_sensors) {
		chosen_select.add(new Option(chosen_sensors[i],i));
	}
}

var update_available_select = function() {
	available_select.innerHTML = "";
	for(r in available_sensors) {
		var sensor = available_sensors[r];
		var available = true;	
		for(i in chosen_sensors) {
			if(sensor==chosen_sensors[i]) {
				available = false;
				break;
			}			
		}
		if(available) {
			available_select.add(new Option(sensor,r));
		}
	}
}

var arrayToText = function(a) {
	var s = "";
	for(i in a) {
		if(i>0) {
			s+="\n";
		}
		s+=a[i];
	}
	return s;
}

var busy_count = 0;

var setStateBusy = function() {
	busy_count++;
	console.log("(inc) "+busy_count);
	document.getElementById("busy").style.visibility = "visible";
}

var setStateReady = function() {
	busy_count--;
	console.log("(dec) "+busy_count);
	if(busy_count<1) {
		document.getElementById("busy").style.visibility = "hidden";
	}
}

function on_choose_selected_button() {
	setStateBusy();
	$.each(available_select.selectedOptions, function(i,option) {
		chosen_sensors.push(available_sensors[option.value]);
	});
	update_chosen_select();
	update_available_select();	
	setStateReady();
}

function on_remove_selected_button() {
	setStateBusy();
	var removed_count = 0;
	$.each(chosen_select.selectedOptions, function(i,option) {
		chosen_sensors.splice(option.value-removed_count,1);
		removed_count++;
	});		
	update_chosen_select();
	update_available_select();
	setStateReady();
}

function on_choose_all_button() {
	setStateBusy();
	$.each(available_select, function(i,option) {
		chosen_sensors.push(available_sensors[option.value]);
	});
	update_chosen_select();
	update_available_select();	
	setStateReady();
}

function on_remove_all_button() {
	setStateBusy();
	chosen_sensors = [];	
	update_chosen_select();
	update_available_select();
	setStateReady();
	/*chosen_plots = [];
	update_chosen_select();
	update_available_select();*/
}

$(document).ready(function(){
	setStateBusy();
	
	chosen_select = document.getElementById("chosen_select");
	available_select = document.getElementById("available_select");

	chosen_select.ondblclick = function(){
		setStateBusy();
		chosen_sensors.splice(chosen_select.value,1);
		update_chosen_select();
		update_available_select();
		setStateReady();
	};
	
	available_select.ondblclick = function(){
		setStateBusy();
		chosen_sensors.push(available_sensors[available_select.value]);
		update_chosen_select();
		update_available_select();
		setStateReady();
	}
	
	$("#button_cancel").button();
	document.getElementById("button_cancel").onclick = function() {
		setStateBusy();
		window.location = "export.html";
		setStateReady();
	}
	
	$("#button_apply").button();
	document.getElementById("button_apply").onclick = function() {	
		setStateBusy();
		$.post("/export/apply_sensors",arrayToText(chosen_sensors))
		 .done(function() {
			window.location = "export.html";
			setStateReady();
		 })
		 .fail(function() {alert("error sending data");setStateReady();})		 
	}
	
	getID("choose_selected_button").onclick = on_choose_selected_button;
	getID("remove_selected_button").onclick = on_remove_selected_button;
	getID("choose_all_button").onclick = on_choose_all_button;
	getID("remove_all_button").onclick = on_remove_all_button;	
	
	setStateBusy();
	$.get("/export/sensors").done(function(data) {		
		chosen_sensors = [];
		console.log("data: ["+data+"]");
		rows = splitData(data);
		for(i in rows) {
			console.log("row: ["+rows[i]+"]");
			chosen_sensors.push(rows[i][0]);
		}
		update_chosen_select();
		update_available_select();
		setStateReady();
	}).fail(function() {alert("error getting data");setStateReady();});
	
	var get_sensor_list = function(region) {
		setStateBusy();
		$.get("/tsdb/region_sensor_list?region="+region).done(function(data) {
			available_sensors = [];
			rows = splitData(data);
			for(i in rows) {
				available_sensors.push(rows[i][0]);
			}
			update_chosen_select();
			update_available_select();
			setStateReady();
		}).fail(function() {alert("error getting data");setStateReady();});
	}

	var get_region = function() {
		incTask();
		$.get("/export/region").done(function(data) {
			var rows = splitData(data);	
			var region = rows[0][0];
			get_sensor_list(region);
			decTask();
		}).fail(function() {alert("error getting data");decTask();});	
	}

	get_region();
	update_chosen_select();
	update_available_select();
	
	setStateReady();
	
	$("button").button().tooltip();
})

</script>

<link rel="stylesheet" href="jquery-ui.css">
<link rel="stylesheet" type="text/css" href="querytimeseries.css">

<style type="text/css">

#box_centered {
    display:inline-block;
    width:200px;
    vertical-align:top
    background: yellow;
    padding: 2em 0;
}

.button_centered {
    display: table;
    margin: 0 auto;
}

 
</style>

</head>

<body>
<div class="bg">
<p style="text-align:right"><a href="index.html">back to Start Page<a><br><a href="export.html">back to Export Summary Page</a><p>
<h1 style="text-align:center">Export Time Series - choose sensors</h1>
<p id="busy" style="text-align:right;visibility:hidden">busy...<p>
<div style="display:inline-block">status:</div>
<div id="status" style="display:inline-block">init...</div>
<div style="text-align:right"> <button id="button_instructions" onclick="show_instructions()">Show Instructions</button> </div> 
<hr/>
</div>
<div id="div_instructions" style="display:none">
<script type="text/javascript">
function show_instructions() {
	if(document.getElementById("div_instructions").style.display==="none") {
		document.getElementById("div_instructions").style.display = "inline";
		document.getElementById("button_instructions").innerHTML = "Hide Instructions";
	} else {
		document.getElementById("div_instructions").style.display = "none";
		document.getElementById("button_instructions").innerHTML = "Show Instructions";
	}
}
</script>
<h3>Instructions</h3>
On this page you can choose the senors of which the data from the selected plots should be exported. click on "cancel" to discard changed. click on "apply sensors" to confirm changes.
<br>
<br>
Double-click on one sensor in the box of "Available Sensors" to add it to your chosen sensors in the box "Chosen Sensors" and vice versa.
<hr/>
</div>
<h3>Actions</h3>
<button id="button_cancel">cancel</button>
<button id="button_apply">apply chosen sensors</button>
<hr/>
<h3>Select Sensors</h3>

<p>
<div style="display:inline-block;width:200px;vertical-align:top">
<label for="chosen_select">Chosen Sensors</label>
<select id="chosen_select" size="5" multiple="multiple" style="height:300px">
<option>plt1</option>
<option>plt2</option>
</select>
</div>

<div id="box_centered" style="display:inline-block;width:200px;vertical-align:top">
<button class="button_centered" title="choose selected sensors" id="choose_selected_button">&lt;</button>
<button class="button_centered" title="remove selected sensors" id="remove_selected_button">&gt;</button>
<button class="button_centered" title="choose all sensors" id="choose_all_button">&lt;&lt;</button>
<button class="button_centered" title="remove all chosen sensors" id="remove_all_button">&gt;&gt;</button>
</div>

<div style="display:inline-block;width:200px;vertical-align:top">
<label for="available_select">Available Sensors</label>
<select id="available_select" size="5" multiple="multiple" style="height:300px">
<option>plt1</option>
<option>plt2</option>
</select>
</div>
</p>
</body>
</html>